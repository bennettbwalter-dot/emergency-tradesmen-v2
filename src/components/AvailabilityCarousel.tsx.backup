
import { useState, useEffect } from 'react';
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Star, MapPin, Shield } from "lucide-react";
import { QuoteRequestModal } from "@/components/QuoteRequestModal";
import { fetchPaidBusinesses } from "@/lib/businessService";
import type { Business } from "@/lib/businesses";

interface AvailabilityCarouselProps {
    city?: string;
    trade?: string;
    className?: string;
}

interface ProfileDisplay {
    id: string;
    name: string;
    trade: string;
    city: string;
    image: string;
    rating: number;
    reviewCount: number;
    isReal: boolean;
    business?: Business;
}

export function AvailabilityCarousel({ city, trade, className = "" }: AvailabilityCarouselProps) {
    const [profiles, setProfiles] = useState<ProfileDisplay[]>([]);
    const [loading, setLoading] = useState(true);

    // Trade-specific placeholders
    const getPlaceholders = (forcedTrade?: string, forcedCity?: string) => {
        const tradeKey = (forcedTrade || 'default').toLowerCase();
        const loc = forcedCity || 'Local';

        const commonPlaceholders = [
            {
                name: "James Wilson",
                image: "https://images.unsplash.com/photo-1504328345606-18bbc8c9d7d1?w=400&h=400&auto=format&fit=crop",
                rating: 4.9,
                reviews: 124
            },
            {
                name: "Sarah Thompson",
                image: "https://images.unsplash.com/photo-1581092918056-0c4c3acd3789?w=400&h=400&auto=format&fit=crop",
                rating: 5.0,
                reviews: 89
            },
            {
                name: "Mike Roberts",
                image: "https://images.unsplash.com/photo-1621905251189-08b45d6a269e?w=400&h=400&auto=format&fit=crop",
                rating: 4.8,
                reviews: 215
            },
            {
                name: "David Chen",
                image: "https://images.unsplash.com/photo-1607472586893-edb57bdc0e39?w=400&h=400&auto=format&fit=crop",
                rating: 4.9,
                reviews: 156
            },
            {
                name: "Emma Davis",
                image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=400&auto=format&fit=crop",
                rating: 5.0,
                reviews: 92
            }
        ];

        return commonPlaceholders.map((p, i) => ({
            id: `placeholder-${i}`,
            name: p.name,
            trade: forcedTrade ? forcedTrade.charAt(0).toUpperCase() + forcedTrade.slice(1) : (['Electrician', 'Plumber', 'Locksmith', 'Gas Engineer'][i % 4]),
            city: loc,
            image: p.image,
            rating: p.rating,
            reviewCount: p.reviews,
            isReal: false
        }));
    };

    useEffect(() => {
        async function loadProfiles() {
            setLoading(true);
            try {
                console.log('[AvailabilityCarousel] Fetching businesses for trade:', trade, 'city:', city);
                // 1. Try to fetch real "Paid" businesses
                const paidBusinesses = await fetchPaidBusinesses(trade, city);
                console.log('[AvailabilityCarousel] Fetched businesses:', paidBusinesses.length, paidBusinesses);

                let displayProfiles: ProfileDisplay[] = [];

                // 2. Map real businesses if any
                if (paidBusinesses.length > 0) {
                    console.log('[AvailabilityCarousel] Mapping', paidBusinesses.length, 'real businesses');
                    displayProfiles = paidBusinesses.map(b => ({
                        id: b.id,
                        name: b.name,
                        trade: b.trade || (trade ? trade.charAt(0).toUpperCase() + trade.slice(1) : 'Tradesperson'),
                        city: b.city || (city || 'UK'),
                        image: "https://images.unsplash.com/photo-1504328345606-18bbc8c9d7d1?w=400&h=400&auto=format&fit=crop", // Fallback if business has no photo
                        rating: b.rating,
                        reviewCount: b.reviewCount,
                        isReal: true,
                        business: b
                    }));
                } else {
                    console.log('[AvailabilityCarousel] No real businesses, using placeholders');
                }

                // 3. If fewer than 5, pad with placeholders
                if (displayProfiles.length < 5) {
                    const placeholders = getPlaceholders(trade, city);
                    // Add placeholders until we have 6 total or used all placeholders
                    const needed = 6 - displayProfiles.length;
                    displayProfiles = [...displayProfiles, ...placeholders.slice(0, needed)];
                }

                console.log('[AvailabilityCarousel] Final profiles:', displayProfiles.length, displayProfiles);
                setProfiles(displayProfiles);
            } catch (error) {
                console.error("Failed to load availability carousel:", error);
                setProfiles(getPlaceholders(trade, city));
            } finally {
                setLoading(false);
            }
        }

        loadProfiles();
    }, [city, trade]);

    if (loading) return null; // Or skeleton

    return (
        <div className={`w-full py-6 ${className}`}>
            <div className="flex items-center justify-between mb-4 md:px-0">
                <div className="flex items-center gap-2">
                    <span className="relative flex h-3 w-3">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-500 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <h3 className="text-sm font-semibold uppercase tracking-wider text-green-600">
                        {city ? `${city} Pros Online Now` : 'Trusted Pros Online'} • {profiles.length} available
                    </h3>
                </div>
            </div>

            {/* Scroll Container */}
            <div
                className="flex overflow-x-auto gap-6 pb-6 snap-x snap-mandatory scrollbar-hide -mx-4 px-4 md:mx-0 md:px-0"
                style={{
                    overflowX: 'auto',
                    overflowY: 'hidden',
                    display: 'flex',
                    flexWrap: 'nowrap',
                    WebkitOverflowScrolling: 'touch'
                }}
            >
                {profiles.map((profile) => (
                    <div key={profile.id} className="snap-center shrink-0 w-80">
                        <Card className="p-6 border-gold/20 bg-card hover:border-gold/50 transition-all duration-300 h-full shadow-lg hover:shadow-xl">
                            <div className="flex items-start gap-4 mb-4">
                                <div className="relative shrink-0">
                                    <div className="w-20 h-20 rounded-full overflow-hidden border-2 border-gold/30">
                                        <img
                                            src={profile.image}
                                            alt={profile.name}
                                            className="w-full h-full object-cover"
                                            loading="lazy"
                                        />
                                    </div>
                                    <div className="absolute -bottom-1 -right-1 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-full border-2 border-white">
                                        ONLINE
                                    </div>
                                </div>
                                <div className="min-w-0 flex-1">
                                    <h4 className="font-bold text-foreground text-base mb-1">{profile.name}</h4>
                                    <p className="text-sm text-muted-foreground mb-2">{profile.trade}</p>
                                    <div className="flex items-center gap-1.5 text-sm text-gold font-medium">
                                        <Star className="w-4 h-4 fill-current" />
                                        <span>{profile.rating.toFixed(1)}</span>
                                        <span className="text-muted-foreground">({profile.reviewCount})</span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center gap-2 text-sm text-muted-foreground mb-5">
                                <MapPin className="w-4 h-4" />
                                <span>{profile.city}</span>
                                <span className="mx-1">•</span>
                                <Shield className="w-4 h-4 text-green-600" />
                                <span className="text-green-600 text-xs font-semibold uppercase">Verified</span>
                            </div>

                            <div className="mt-auto">
                                <QuoteRequestModal
                                    businessName={profile.isReal ? profile.business?.name : "Available Pro"}
                                    businessId={profile.isReal ? profile.business?.id : "general"}
                                    tradeName={profile.trade}
                                    className="w-full bg-gold hover:bg-gold/90 text-white text-sm h-10 font-semibold"
                                    triggerText="Request Quote"
                                />
                            </div>
                        </Card>
                    </div>
                ))}
            </div>

            <style>{`
                .scrollbar-hide::-webkit-scrollbar {
                    display: none;
                }
                .scrollbar-hide {
                    -ms-overflow-style: none;
                    scrollbar-width: none;
                }
            `}</style>
        </div>
    );
}
